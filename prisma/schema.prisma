// This is your Prisma schema file,
// learn more about it in the docs: https://pris.ly/d/prisma-schema

// Looking for ways to speed up your queries, or scale easily with your serverless or edge functions?
// Try Prisma Accelerate: https://pris.ly/cli/accelerate-init

generator client {
  provider = "prisma-client"
  output   = "../generated/prisma"
  moduleFormat = "cjs"
}

datasource db {
  provider = "mysql"
  url      = env("DATABASE_URL")
}

model User {
    id  Int @id @default(autoincrement())
    username String @db.VarChar(50)
    email   String  @unique
    password    String? // NULL for OAuth users
    role    Role    @default(pending)
    region   String?
    country   String?
    verified    Boolean @default(false)
    avatar Bytes? @db.Binary(16) @unique
    notes   String?
    description String? @db.Text
    banned  Boolean @default(false)

    user_games  UserGame[]

    sent_messages   Messages[]  @relation("SentMessage")
    received_messages   Messages[]  @relation("ReceivedMessage")

    sent_reports    UserReports[]   @relation("SentReports")
    received_reports    UserReports[]   @relation("ReceivedReports")


    // OAuth fields
    provider  Provider?  // e.g., "google", "discord"
    providerId String? // OAuth user ID from provider
}

enum Role {
    player
    team
    admin
    pending
}

enum Provider {
    google
    discord
}

model Game {
    id  Int @id @default(autoincrement())
    name String @db.VarChar(50)
    attributes  GameAttribute[]
    user_games   UserGame[]
}

model GameAttribute {
    id  Int @id @default(autoincrement())
    name    String  @db.VarChar(50)
    game_id Int
    game    Game    @relation(fields: [game_id], references: [id], onDelete: Cascade)
    value   UserGameAttributeValue[]
}

model UserGame {
    id  Int @id @default(autoincrement())
    user_id Int
    game_id Int
    user    User    @relation(fields: [user_id], references: [id], onDelete: Cascade)
    game    Game    @relation(fields: [game_id], references: [id], onDelete: Cascade)
    attribute_values    UserGameAttributeValue[]
    custom_attributes  UserGameCustomAttribute[]
    Links   UserGameLinks[]
    WinsLoss  WinsLoss[]

    @@unique([user_id, game_id])
}

model UserGameAttributeValue {
    id  Int @id @default(autoincrement())
    value   String? @db.VarChar(50)
    user_game_id    Int
    game_attribute_id   Int
    
    user_game   UserGame    @relation(fields: [user_game_id], references: [id], onDelete: Cascade)
    game_attribute   GameAttribute    @relation(fields: [game_attribute_id], references: [id], onDelete: Cascade)
    @@unique([user_game_id, game_attribute_id])
}

model UserGameCustomAttribute {
    id  Int @id @default(autoincrement())
    user_game_id Int
    name    String  @db.VarChar(50)
    value   String  @db.VarChar(50)
    user_game   UserGame    @relation(fields: [user_game_id], references: [id], onDelete: Cascade)
}

model UserGameLinks {
    id  Int @id @default(autoincrement())
    user_game_id Int
    name    String  @db.VarChar(50)
    value   String  @db.VarChar(100)
    user_game   UserGame    @relation(fields: [user_game_id], references: [id], onDelete: Cascade)
}

model WinsLoss {
    id  Int @id @default(autoincrement())
    user_game_id Int
    date    DateTime    @db.Date
    value   Int
    type    WinLoss_type
    user_game   UserGame    @relation(fields: [user_game_id], references: [id], onDelete: Cascade)
}

enum WinLoss_type {
    Win
    Loss
}

model Announcements {
    id  Int @id @default(autoincrement())
    title   String
    announcement    String  @db.Text
    date    DateTime    @db.Date
}

model Messages {
    id  Int @id @default(autoincrement())
    sender_id   Int
    receiver_id Int
    content String  @db.Text
    read    Boolean @default(false)
    timestamp   DateTime    @default(now())

    sender User    @relation("SentMessage", fields: [sender_id], references: [id], onDelete: Cascade)
    receiver User    @relation("ReceivedMessage", fields: [receiver_id], references: [id], onDelete: Cascade)
    AIReport    AIReports?
}

model UserReports {
    id  Int @id @default(autoincrement())
    reporter_id    Int
    target_id    Int
    reason  String
    description String  @db.Text
    is_reviewed Boolean @default(false)

    timestamp   DateTime    @default(now())

    reporter    User    @relation("SentReports", fields: [reporter_id], references: [id], onDelete: Cascade)
    target    User    @relation("ReceivedReports", fields: [target_id], references: [id], onDelete: Cascade)
}

model AIReports {
    id  Int @id @default(autoincrement())
    target_message_id  Int  @unique
    timestamp   DateTime    @default(now())
    is_reviewed Boolean @default(false)
    toxicity    Float

    message Messages    @relation(fields: [target_message_id], references: [id], onDelete: Cascade)
}

model Contacts {
    id  Int @id @default(autoincrement())
    email   String  @db.VarChar(100)
    name    String  @db.VarChar(50)
    message String  @db.Text
    timestamp   DateTime    @default(now())
}
